<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Locker - Gerenciador de Senhas</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="dashboard">
    <!-- Top Bar -->
    <div class="top-bar">
      <h1>üîê Locker - Gerenciador de Senhas</h1>
      <button class="logout-btn" onclick="logout()">üö™ Logout</button>
    </div>

    <!-- Bot√£o Criar -->
    <button class="create-btn" onclick="openModal('createModal')">‚ûï Criar Novo</button>

    <!-- Tabela -->
    <table id="lockerTable">
      <thead>
        <tr>
          <th>Site</th>
          <th>Usu√°rio</th>
          <th>Senha</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Modal Criar -->
    <div id="createModal" class="modal">
      <div class="modal-content">
        <h3>‚ûï Adicionar novo site</h3>
        <label for="createSite">Site</label>
        <input type="text" id="createSite" placeholder="Ex: www.site.com" required>

        <label for="createUser">Usu√°rio</label>
        <input type="text" id="createUser" placeholder="Usu√°rio (Deixe vazio para padr√£o)" required>

        <label for="createPassword">Senha</label>
        <input type="password" id="createPassword" placeholder="Deixe vazio para gerar" required>

        <div class="btn-row">
          <button class="create-btn" onclick="submitCreate()">Salvar</button>
          <button class="close-btn" onclick="closeModal('createModal')">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal Editar -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <h3>‚úèÔ∏è Editar site</h3>
        <label for="editSite">Site</label>
        <input type="text" id="editSite" readonly>

        <label for="editUser">Novo usu√°rio</label>
        <input type="text" id="editUser" placeholder="Usu√°rio (Deixe vazio para padr√£o)">
        
        <div id="editPasswordGroup">
          <label for="editUser">Nova Senha</label>
          <input type="text" id="editPassword" placeholder="Deixe vazio para gerar">
        </div>


        <div class="checkbox-group">
          <input type="checkbox" id="editPasswordCheck" onclick="togglePasswordField('editPasswordCheck')">
          <label for="editPasswordCheck">Mudar senha</label>
        </div>

        <div class="btn-row">
          <button class="edit-btn" onclick="submitEdit()">Salvar</button>
          <button class="close-btn" onclick="closeModal('editModal')">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toast-container"></div>

  <!-- Scripts -->
  <script>
    let currentEditSite = null;
    let currentUser = null;

    function showToast(message, type="success") {
      const container = document.getElementById("toast-container");
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    async function loadData() {
      const res = await fetch("/home", { headers: { "Accept": "application/json" } });
      const data = await res.json();
      const tbody = document.querySelector("#lockerTable tbody");
      tbody.innerHTML = "";

      data.forEach((row, idx) => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${row.site}</td>
          <td>${row.user}</td>
          <td>
            <span id="pw-${idx}" data-password="${row.password}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
            <button class="toggle-btn" onclick="togglePassword(${idx})">üëÅ</button>
          </td>
          <td>
            <button class="edit-btn" onclick="openEditModal('${row.site}','${row.user}')">Editar</button>
            <button class="delete-btn" onclick="deleteEntry('${row.site}')">Excluir</button>
          </td>
        `;

        tbody.appendChild(tr);
      });
    }

    function togglePasswordField(id) { 
      const check = document.getElementById(id);
      const field = document.getElementById("editPasswordGroup");
      if (check.checked){
        field.style.visibility = "visible";
      }
      else {
        field.style.visibility = "collapse";
      };
    }

    function togglePassword(id) {
      const span = document.getElementById("pw-" + id);
      span.textContent = (span.textContent === "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢") 
        ? span.dataset.password 
        : "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
    }

    function openModal(id) {
      document.getElementById(id).style.display = "flex";
    }
    function closeModal(id) {
      document.getElementById(id).style.display = "none";
    }

    async function submitCreate() {
      const site = document.getElementById("createSite").value;
      const user = document.getElementById("createUser").value;
      const password = document.getElementById("createPassword").value;
      if (!site) return;

      const res = await fetch("/home", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ site, user, password })
      });
      const data = await res.json();
      if (res.ok) {
        showToast("Criado com sucesso! Senha: " + data.password, "success");
        closeModal('createModal');
        loadData();
      } else {
        showToast("Erro ao criar", "error");
      }
    }

    function openEditModal(site, user) {
      currentEditSite = site;
      currentEditUser = user;
      document.getElementById("editPasswordGroup").style.visibility = "hidden";
      document.getElementById("editSite").value = site;
      document.getElementById("editUser").value = user;
      document.getElementById("editPasswordCheck").checked = false;
      openModal('editModal');
    }

    async function submitEdit() {
      const site = currentEditSite;
      const user = document.getElementById("editUser").value;
      const password = document.getElementById("editPassword").value;
      const changePassword = document.getElementById("editPasswordCheck").checked;
      if (!site) return;

      const res = await fetch("/home", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ site, user, change_password: changePassword, password })
      });
      const data = await res.json();
      if (res.ok) {
        showToast("Atualizado com sucesso! " + 
                  (changePassword ? "Nova senha: " + data.password : "Senha mantida"), 
                  "success");
        closeModal('editModal');
        loadData();
      } else {
        showToast(data.error, "error");
      }
    }

    async function deleteEntry(site) {
      if (!confirm("Deseja excluir o site " + site + "?")) return;
      const res = await fetch("/home", {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ site })
      });
      const data = await res.json();
      if (res.ok) {
        showToast(data.message, "success");
        loadData();
      } else {
        showToast(data.error, "error");
      }
    }

    function logout() {
      window.location.href = "/logout";
    }

    loadData();
  </script>
</body>
</html>
